# 実装書：幹事向け飲み会管理サービス

## 対象スコープ
- 参加者ページ・幹事ページのUI改善
- 認可方針の整理（幹事ログインのみ）
- 会計確定の取り消しと金額調整ロジックの変更

## 実装概要
- 幹事権限はログインユーザー（ownerUserId）一致のみで判定するように統一。
- メール/パスワードのログイン後はフルリロードに切り替え、ヘッダのログイン表示を即時反映。
- UI文言を日本語に統一。
- 参加者ページの日程・投票表示に「時間」を含める表示へ変更。
- 日程候補の「確定」ラベルは日程の右側に表示。
- 支払管理に申請者名を表示。
- 会計確定の取り消し（会計ステータスを未確定へ戻し、支払情報をリセット）を追加。
- 金額調整が入力された場合、調整合計を差し引いた残額を未調整人数で割る計算へ変更。
- 会計確定エラーは会計カード内に表示。
- 会計未確定時の「支払申請可」メッセージは表示しない。
- 参加者ページ/幹事ページのスクロール位置を操作後に維持（投票送信後のみ上に戻す）。
- 参加者ページのスマホ表示で日程候補を「参加者固定 + 日付横スクロール」テーブルに最適化。
- 管理画面でイベント名・メモを編集できるようにし、編集中は関連リンクを非表示。
- 日程確定の取り消しを追加（出席・会計・支払をリセット）し、確認ダイアログを表示。
- 投票締切は状態に応じてボタンを切り替え表示。
- トップページはログイン状態に応じて導線を切り替え、使い方案内ページを追加。
- イベント作成ページは未ログイン時にログインへリダイレクト。

## 変更内容（主要）
### 認可/認証
- 幹事権限は `ownerUserId` 一致のみで判定。
- 同一端末判定は採用しない方針に整理。

### 参加者ページ
- 日程候補・投票フォームに「時刻」を含む表示へ変更。
- 日程候補の確定ラベルを日程の右側に配置。
- 会計未確定時の支払申請案内文言を非表示。
- スマホは参加者固定 + 日付横スクロールの表に切り替え、最頻日程を強調。
- 投票コメントはスマホは右端列、PCは最下段のコメント行に表示。
- 支払申請/取消後はスクロール位置を維持（投票送信後は上に戻す）。

### 幹事ページ
- 支払管理に「申請者名」を表示。
- 会計確定後は「会計確定を取り消す」ボタンのみ表示（未確定時は「会計を確定する」）。
- 会計確定エラーは会計カード内に表示。
- 日程確定後は「日程確定を取り消す」ボタンを表示し、取り消し時に確認ダイアログを出す。
- 投票締切は状態に応じて「締切にする/締切を解除」を切り替え表示。
- イベント情報（名/メモ）を編集可能にし、編集中は参加者URL・イベントページ導線を非表示。
- 操作後のスクロール位置を維持。

### 会計ロジック
- 金額調整の合計を差し引いた残額を、未調整人数で割る方式に変更。
- 調整合計が総額を超える／全員に調整が入り残額が合わない場合は 400 で弾く。
- 会計取り消しは会計ステータスを未確定に戻し、支払情報は削除でリセット。

## 画面/文言の統一
- UI内の英語表記を日本語へ統一。
- 支払ステータス表示は「未申請/申請中/承認済み」に統一。

## 影響箇所（ファイル）
- `app/login/page.tsx`
- `app/signup/page.tsx`
- `app/page.tsx`
- `app/guide/page.tsx`
- `app/events/new/page.tsx`
- `app/events/new/new-event-client.tsx`
- `app/e/[publicId]/public-event-client.tsx`
- `app/e/[publicId]/admin/admin-event-client.tsx`
- `app/api/events/[publicId]/accounting/route.ts`
- `app/api/events/[publicId]/schedule/route.ts`
- `.kiro/steering/tech.md`
- `.kiro/specs/飲み会管理/design.md`
- `.kiro/specs/飲み会管理/tasks.md`

## 仕様メモ
- 支払申請は会計確定後・実出席者のみ。
- 会計確定の取り消しは、支払情報をリセットして再計算可能にする。
- 幹事権限はログイン必須（`ownerUserId`一致のみ）。
